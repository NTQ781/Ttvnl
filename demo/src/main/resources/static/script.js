// ========== HIRAGANA & KATAKANA DATA ==========
const hiraganaData = [
  { char: "„ÅÇ", romaji: "a", audio: "/audio/hiragana/a.mp3" },
  { char: "„ÅÑ", romaji: "i", audio: "/audio/hiragana/i.mp3" },
  { char: "„ÅÜ", romaji: "u", audio: "/audio/hiragana/u.mp3" },
  { char: "„Åà", romaji: "e", audio: "/audio/hiragana/e.mp3" },
  { char: "„Åä", romaji: "o", audio: "/audio/hiragana/o.mp3" },

  { char: "„Åã", romaji: "ka", audio: "/audio/hiragana/ka.mp3" },
  { char: "„Åç", romaji: "ki", audio: "/audio/hiragana/ki.mp3" },
  { char: "„Åè", romaji: "ku", audio: "/audio/hiragana/ku.mp3" },
  { char: "„Åë", romaji: "ke", audio: "/audio/hiragana/ke.mp3" },
  { char: "„Åì", romaji: "ko", audio: "/audio/hiragana/ko.mp3" },

  { char: "„Åï", romaji: "sa", audio: "/audio/hiragana/sa.mp3" },
  { char: "„Åó", romaji: "shi", audio: "/audio/hiragana/shi.mp3" },
  { char: "„Åô", romaji: "su", audio: "/audio/hiragana/su.mp3" },
  { char: "„Åõ", romaji: "se", audio: "/audio/hiragana/se.mp3" },
  { char: "„Åù", romaji: "so", audio: "/audio/hiragana/so.mp3" },

  { char: "„Åü", romaji: "ta", audio: "/audio/hiragana/ta.mp3" },
  { char: "„Å°", romaji: "chi", audio: "/audio/hiragana/chi.mp3" },
  { char: "„Å§", romaji: "tsu", audio: "/audio/hiragana/tsu.mp3" },
  { char: "„Å¶", romaji: "te", audio: "/audio/hiragana/te.mp3" },
  { char: "„Å®", romaji: "to", audio: "/audio/hiragana/to.mp3" },

  { char: "„Å™", romaji: "na", audio: "/audio/hiragana/na.mp3" },
  { char: "„Å´", romaji: "ni", audio: "/audio/hiragana/ni.mp3" },
  { char: "„Å¨", romaji: "nu", audio: "/audio/hiragana/nu.mp3" },
  { char: "„Å≠", romaji: "ne", audio: "/audio/hiragana/ne.mp3" },
  { char: "„ÅÆ", romaji: "no", audio: "/audio/hiragana/no.mp3" },

  { char: "„ÅØ", romaji: "ha", audio: "/audio/hiragana/ha.mp3" },
  { char: "„Å≤", romaji: "hi", audio: "/audio/hiragana/hi.mp3" },
  { char: "„Åµ", romaji: "fu", audio: "/audio/hiragana/fu.mp3" },
  { char: "„Å∏", romaji: "he", audio: "/audio/hiragana/he.mp3" },
  { char: "„Åª", romaji: "ho", audio: "/audio/hiragana/ho.mp3" },

  { char: "„Åæ", romaji: "ma", audio: "/audio/hiragana/ma.mp3" },
  { char: "„Åø", romaji: "mi", audio: "/audio/hiragana/mi.mp3" },
  { char: "„ÇÄ", romaji: "mu", audio: "/audio/hiragana/mu.mp3" },
  { char: "„ÇÅ", romaji: "me", audio: "/audio/hiragana/me.mp3" },
  { char: "„ÇÇ", romaji: "mo", audio: "/audio/hiragana/mo.mp3" },

  { char: "„ÇÑ", romaji: "ya", audio: "/audio/hiragana/ya.mp3" },
  { char: "„ÇÜ", romaji: "yu", audio: "/audio/hiragana/yu.mp3" },
  { char: "„Çà", romaji: "yo", audio: "/audio/hiragana/yo.mp3" },

  { char: "„Çâ", romaji: "ra", audio: "/audio/hiragana/ra.mp3" },
  { char: "„Çä", romaji: "ri", audio: "/audio/hiragana/ri.mp3" },
  { char: "„Çã", romaji: "ru", audio: "/audio/hiragana/ru.mp3" },
  { char: "„Çå", romaji: "re", audio: "/audio/hiragana/re.mp3" },
  { char: "„Çç", romaji: "ro", audio: "/audio/hiragana/ro.mp3" },

  { char: "„Çè", romaji: "wa", audio: "/audio/hiragana/wa.mp3" },
  { char: "„Çí", romaji: "wo", audio: "/audio/hiragana/wo.mp3" },

  { char: "„Çì", romaji: "n", audio: "/audio/hiragana/n.mp3" }
];

const katakanaData = [
  { char: "„Ç¢", romaji: "a", audio: "/audio/katakana/a.mp3" },
  { char: "„Ç§", romaji: "i", audio: "/audio/katakana/i.mp3" },
  { char: "„Ç¶", romaji: "u", audio: "/audio/katakana/u.mp3" },
  { char: "„Ç®", romaji: "e", audio: "/audio/katakana/e.mp3" },
  { char: "„Ç™", romaji: "o", audio: "/audio/katakana/o.mp3" },

  { char: "„Ç´", romaji: "ka", audio: "/audio/katakana/ka.mp3" },
  { char: "„Ç≠", romaji: "ki", audio: "/audio/katakana/ki.mp3" },
  { char: "„ÇØ", romaji: "ku", audio: "/audio/katakana/ku.mp3" },
  { char: "„Ç±", romaji: "ke", audio: "/audio/katakana/ke.mp3" },
  { char: "„Ç≥", romaji: "ko", audio: "/audio/katakana/ko.mp3" },

  { char: "„Çµ", romaji: "sa", audio: "/audio/katakana/sa.mp3" },
  { char: "„Ç∑", romaji: "shi", audio: "/audio/katakana/shi.mp3" },
  { char: "„Çπ", romaji: "su", audio: "/audio/katakana/su.mp3" },
  { char: "„Çª", romaji: "se", audio: "/audio/katakana/se.mp3" },
  { char: "„ÇΩ", romaji: "so", audio: "/audio/katakana/so.mp3" },

  { char: "„Çø", romaji: "ta", audio: "/audio/katakana/ta.mp3" },
  { char: "„ÉÅ", romaji: "chi", audio: "/audio/katakana/chi.mp3" },
  { char: "„ÉÑ", romaji: "tsu", audio: "/audio/katakana/tsu.mp3" },
  { char: "„ÉÜ", romaji: "te", audio: "/audio/katakana/te.mp3" },
  { char: "„Éà", romaji: "to", audio: "/audio/katakana/to.mp3" },

  { char: "„Éä", romaji: "na", audio: "/audio/katakana/na.mp3" },
  { char: "„Éã", romaji: "ni", audio: "/audio/katakana/ni.mp3" },
  { char: "„Éå", romaji: "nu", audio: "/audio/katakana/nu.mp3" },
  { char: "„Éç", romaji: "ne", audio: "/audio/katakana/ne.mp3" },
  { char: "„Éé", romaji: "no", audio: "/audio/katakana/no.mp3" },

  { char: "„Éè", romaji: "ha", audio: "/audio/katakana/ha.mp3" },
  { char: "„Éí", romaji: "hi", audio: "/audio/katakana/hi.mp3" },
  { char: "„Éï", romaji: "fu", audio: "/audio/katakana/fu.mp3" },
  { char: "„Éò", romaji: "he", audio: "/audio/katakana/he.mp3" },
  { char: "„Éõ", romaji: "ho", audio: "/audio/katakana/ho.mp3" },

  { char: "„Éû", romaji: "ma", audio: "/audio/katakana/ma.mp3" },
  { char: "„Éü", romaji: "mi", audio: "/audio/katakana/mi.mp3" },
  { char: "„É†", romaji: "mu", audio: "/audio/katakana/mu.mp3" },
  { char: "„É°", romaji: "me", audio: "/audio/katakana/me.mp3" },
  { char: "„É¢", romaji: "mo", audio: "/audio/katakana/mo.mp3" },

  { char: "„É§", romaji: "ya", audio: "/audio/katakana/ya.mp3" },
  { char: "„É¶", romaji: "yu", audio: "/audio/katakana/yu.mp3" },
  { char: "„É®", romaji: "yo", audio: "/audio/katakana/yo.mp3" },

  { char: "„É©", romaji: "ra", audio: "/audio/katakana/ra.mp3" },
  { char: "„É™", romaji: "ri", audio: "/audio/katakana/ri.mp3" },
  { char: "„É´", romaji: "ru", audio: "/audio/katakana/ru.mp3" },
  { char: "„É¨", romaji: "re", audio: "/audio/katakana/re.mp3" },
  { char: "„É≠", romaji: "ro", audio: "/audio/katakana/ro.mp3" },

  { char: "„ÉØ", romaji: "wa", audio: "/audio/katakana/wa.mp3" },
  { char: "„É≤", romaji: "wo", audio: "/audio/katakana/wo.mp3" },

  { char: "„É≥", romaji: "n", audio: "/audio/katakana/n.mp3" }
];

// ========== SHOW SECTIONS ==========
function showSection(id) {
  document.querySelectorAll("main section").forEach(sec => {
    sec.style.display = "none";
  });
  document.getElementById(id).style.display = "block";

  if (id === "hiragana") renderHiraganaGrid();
  if (id === "katakana") renderKatakanaGrid();
  if (id === "doc-hieu") renderReadingList();
  if (id === "nghe-hieu") renderListeningList();
}

// ========== HIRAGANA ==========
function renderHiraganaGrid() {
  const grid = document.getElementById("hiragana-grid");
  grid.innerHTML = "";
  hiraganaData.forEach(item => {
    const cell = document.createElement("div");
    cell.className = "kana-cell";
    cell.innerHTML = `<div>${item.char}</div><div>${item.romaji}</div>`;
    cell.onclick = () => playAudio(item.audio);
    grid.appendChild(cell);
  });
}

// ========== KATAKANA ==========
function renderKatakanaGrid() {
  const grid = document.getElementById("katakana-grid");
  grid.innerHTML = "";
  katakanaData.forEach(item => {
    const cell = document.createElement("div");
    cell.className = "kana-cell";
    cell.innerHTML = `<div>${item.char}</div><div>${item.romaji}</div>`;
    cell.onclick = () => playAudio(item.audio);
    grid.appendChild(cell);
  });
}

// ========== AUDIO PLAYER ==========
function playAudio(url) {
  const audio = new Audio(url);
  audio.play();
}

// ========== READING (ƒê·ªçc-Hi·ªÉu) ==========
async function renderReadingList(level = null) {
  const container = document.getElementById("reading-list");
  container.innerHTML = "<p>ƒêang t·∫£i d·ªØ li·ªáu...</p>";

  let url = "/api/readings";
  if (level) url += "?level=" + level;

  const res = await fetch(url);
  const readings = await res.json();
  container.innerHTML = "";

  readings.forEach((r, idx) => {
    const item = document.createElement("div");
    item.className = "reading-item";
    item.innerHTML = `<div class="title">üìñ ${r.title}</div>`;
    const details = document.createElement("div");
    details.className = "details";

    // N·ªôi dung b√†i
    const content = document.createElement("pre");
    content.textContent = r.content;
    details.appendChild(content);

    // C√¢u h·ªèi
    r.questions.forEach((qa, i) => {
      const qDiv = document.createElement("div");
      qDiv.innerHTML = `<b>C√¢u ${i+1}:</b> ${qa.q}`;
      const ansBtn = document.createElement("button");
      ansBtn.textContent = "Xem ƒë√°p √°n";
      const ansDiv = document.createElement("div");
      ansDiv.style.display = "none";
      ansDiv.innerHTML = `<i>ƒê√°p √°n:</i> ${qa.a} <br><i>D·ªãch:</i> ${qa.t}`;
      ansBtn.onclick = (e) => {
        e.stopPropagation();
        ansDiv.style.display = ansDiv.style.display === "none" ? "block" : "none";
      };
      qDiv.appendChild(ansBtn);
      qDiv.appendChild(ansDiv);
      details.appendChild(qDiv);
    });

    // B√†i d·ªãch
    const transBtn = document.createElement("button");
    transBtn.textContent = "üìò B√†i d·ªãch";
    const transDiv = document.createElement("pre");
    transDiv.style.display = "none";
    transDiv.textContent = r.translation;
    transBtn.onclick = (e) => {
      e.stopPropagation();
      transDiv.style.display = transDiv.style.display === "none" ? "block" : "none";
    };
    details.appendChild(transBtn);
    details.appendChild(transDiv);

    details.style.display = "none";
    item.appendChild(details);

    item.querySelector(".title").onclick = () => {
      details.style.display = details.style.display === "none" ? "block" : "none";
    };

    container.appendChild(item);
  });
}

// ========== LISTENING (Nghe-Hi·ªÉu) ==========
async function renderListeningList(level = null) {
  const container = document.getElementById("listening-list");
  container.innerHTML = "<p>ƒêang t·∫£i d·ªØ li·ªáu...</p>";

  let url = "/api/listenings";
  if (level) url += "?level=" + level;

  const res = await fetch(url);
  const listenings = await res.json();
  container.innerHTML = "";

  listenings.forEach((l, idx) => {
    const item = document.createElement("div");
    item.className = "listening-item";
    item.innerHTML = `<div class="title">üéß ${l.title}</div>`;
    const details = document.createElement("div");
    details.className = "details";

    // Audio
    const audio = document.createElement("audio");
    audio.controls = true;
    audio.src = l.audio || l.audioUrl;
    details.appendChild(audio);

    // C√¢u h·ªèi
    l.questions.forEach((q, i) => {
      const qDiv = document.createElement("div");
      qDiv.innerHTML = `<b>C√¢u ${i+1}:</b> ${q} <br>`;
      const input = document.createElement("input");
      input.placeholder = "Nh·∫≠p c√¢u tr·∫£ l·ªùi...";
      qDiv.appendChild(input);
      details.appendChild(qDiv);
    });

    // Script (b·∫£n ch√©p l·ªùi)
    const scriptBtn = document.createElement("button");
    scriptBtn.textContent = "üìÑ B√†i nghe";
    const scriptDiv = document.createElement("pre");
    scriptDiv.style.display = "none";
    scriptDiv.textContent = l.script;
    scriptBtn.onclick = (e) => {
      e.stopPropagation();
      scriptDiv.style.display = scriptDiv.style.display === "none" ? "block" : "none";
    };
    details.appendChild(scriptBtn);
    details.appendChild(scriptDiv);

    details.style.display = "none";
    item.appendChild(details);

    item.querySelector(".title").onclick = () => {
      details.style.display = details.style.display === "none" ? "block" : "none";
    };

    container.appendChild(item);
  });
}

// ========== SHOW LEVEL (N1-N5) ==========
function showLevel(level) {
  showSection("doc-hieu");
  renderReadingList(level);
  renderListeningList(level);
}

// ========== INIT ==========
window.onload = () => {
  // m·∫∑c ƒë·ªãnh hi·ªán Hiragana
  showSection("hiragana");

  // g·∫Øn s·ª± ki·ªán cho menu nav
  document.querySelectorAll(".nav li").forEach(item => {
    item.addEventListener("click", () => {
      const sectionId = item.getAttribute("data-section");
      if (sectionId) showSection(sectionId);
    });
  });
};
